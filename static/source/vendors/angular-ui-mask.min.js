angular.module("ui.mask",[]).value("uiMaskConfig",{maskDefinitions:{9:/\d/,A:/[a-zA-Z]/,"*":/[a-zA-Z0-9]/}}).directive("uiMask",["uiMaskConfig","$parse",function(H,O){return{priority:100,require:"ngModel",restrict:"A",compile:function(){return function(x,e,h,k){function I(){p=!1;v&&(e.unbind("blur",J),e.unbind("mousedown",t),e.unbind("mouseup",t),e.unbind("input",n),e.unbind("keyup",n),e.unbind("click",n),e.unbind("focus",n),v=!1);angular.isDefined(K)?e.attr("placeholder",K):e.removeAttr("placeholder");
    angular.isDefined(L)?e.attr("maxlength",L):e.removeAttr("maxlength");e.val(k.$modelValue);k.$viewValue=k.$modelValue;return!1}function y(a){var b="",c=w.slice();a=a.toString();angular.forEach(M,function(b){a=a.replace(b,"")});angular.forEach(a.split(""),function(a){c.length&&c[0].test(a)&&(b+=a,c.shift())});return b}function z(a){var b="",c=l.slice();angular.forEach(q.split(""),function(d,e){a.length&&e===c[0]?(b+=a.charAt(0)||"_",a=a.substr(1),c.shift()):b+=d});return b}function P(a){var b=0;l=[];
    w=[];q="";if("string"===typeof a){r=0;var c=!1;a=a.split("");angular.forEach(a,function(a,e){if(s.maskDefinitions[a]){l.push(b);var f=q,k;k=h.placeholder;k="undefined"!==typeof k&&k[e]?k[e]:"_";q=f+k;w.push(s.maskDefinitions[a]);b++;c||r++}else"?"===a?c=!0:(q+=a,b++)})}l.push(l.slice().pop()+1);M=q.replace(/[_]+/g,"_").replace(/([^_]+)([a-zA-Z0-9])([^_])/g,"$1$2_$3").split("_");p=1<l.length?!0:!1}function J(){A=B=0;m&&0!==f.length||(C="",e.val(""),x.$apply(function(){k.$setViewValue("")}))}function t(a){"mousedown"===
a.type?e.bind("mouseout",D):e.unbind("mouseout",D)}function D(){A=E(this);e.unbind("mouseout",D)}function n(a){a=a||{};var b=a.which,c=a.type;if(16!==b&&91!==b){var d=e.val(),f=F,h=y(d),q=G,m=!1,g=Q(this)||0,s=B||0,p=g-s,u=l[0],n=l[h.length]||l.slice().shift(),r=A||0,v=0<E(this),t=0<r,w=d.length>f.length||r&&d.length>f.length-r,d=d.length<f.length||r&&d.length===f.length-r;a=37<=b&&40>=b&&a.shiftKey;f=8===b||"keyup"!==c&&d&&-1===p;p=46===b||"keyup"!==c&&d&&0===p&&!t;b=(37===b||f||"click"===c)&&g>
    u;A=E(this);if(!a&&(!v||"click"!==c&&"keyup"!==c)){if("input"===c&&d&&!t&&h===q){for(;f&&g>u&&!(-1<l.indexOf(g));)g--;for(;p&&g<n&&-1===l.indexOf(g);)g++;m=l.indexOf(g);h=h.substring(0,m)+h.substring(m+1);m=!0}F=c=z(h);G=h;e.val(c);m&&x.$apply(function(){k.$setViewValue(h)});w&&g<=u&&(g=u+1);b&&g--;for(g=g>n?n:g<u?u:g;!(-1<l.indexOf(g))&&g>u&&g<n;)g+=b?-1:1;(b&&g<n||w&&!(-1<l.indexOf(s)))&&g++;B=g;R(this,g)}}}function Q(a){if(!a)return 0;if(void 0!==a.selectionStart)return a.selectionStart;if(document.selection){a.focus();
    var b=document.selection.createRange();b.moveStart("character",a.value?-a.value.length:0);return b.text.length}return 0}function R(a,b){if(!a)return 0;if(0!==a.offsetWidth&&0!==a.offsetHeight)if(a.setSelectionRange)a.focus(),a.setSelectionRange(b,b);else if(a.createTextRange){var c=a.createTextRange();c.collapse(!0);c.moveEnd("character",b);c.moveStart("character",b);c.select()}}function E(a){return a?void 0!==a.selectionStart?a.selectionEnd-a.selectionStart:document.selection?document.selection.createRange().text.length:
    0:0}var p=!1,v=!1,l,w,q,M,r,f,C,m,K=h.placeholder,L=h.maxlength,F,G,B,A,s={};h.uiOptions?(s=x.$eval("["+h.uiOptions+"]"),angular.isObject(s[0])&&(s=function(a,b){for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]?angular.extend(b[c],a[c]):b[c]=angular.copy(a[c]));return b}(H,s[0]))):s=H;h.$observe("uiMask",function(a){if(!angular.isDefined(a))return I();P(a);if(!p)return I();f=G=y(k.$modelValue||"");C=F=z(f);a=(m=f.length?f.length>=r:!0)&&f.length?C:"";h.maxlength&&e.attr("maxlength",
        2*l[l.length-1]);e.attr("placeholder",q);e.val(a);k.$viewValue=a;v||(e.bind("blur",J),e.bind("mousedown mouseup",t),e.bind("input keyup click focus",n),v=!0);return!0});h.$observe("placeholder",function(a){angular.isDefined(a)&&(q=a,p&&n())});var N=!1;h.$observe("modelViewValue",function(a){"true"===a&&(N=!0)});x.$watch(h.ngModel,function(a){N&&a&&O(h.ngModel).assign(x,k.$viewValue)});k.$formatters.push(function(a){if(!p)return a;f=y(a||"");m=f.length?f.length>=r:!0;k.$setValidity("mask",m);return m&&
    f.length?z(f):void 0});k.$parsers.push(function(a){if(!p)return a;f=y(a||"");m=f.length?f.length>=r:!0;k.$viewValue=f.length?z(f):"";k.$setValidity("mask",m);""===f&&h.required&&k.$setValidity("required",!1);return m?f:void 0});e.bind("mousedown mouseup",t);Array.prototype.indexOf||(Array.prototype.indexOf=function(a){if(null===this)throw new TypeError;var b=Object(this),c=b.length>>>0;if(0===c)return-1;var d=0;1<arguments.length&&(d=Number(arguments[1]),d!==d?d=0:0!==d&&Infinity!==d&&-Infinity!==
    d&&(d=(0<d||-1)*Math.floor(Math.abs(d))));if(d>=c)return-1;for(d=0<=d?d:Math.max(c-Math.abs(d),0);d<c;d++)if(d in b&&b[d]===a)return d;return-1})}}}}]);