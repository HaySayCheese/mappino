angular.module("ui.mask",[]).value("uiMaskConfig",{maskDefinitions:{9:/\d/,A:/[a-zA-Z]/,"*":/[a-zA-Z0-9]/}}).directive("uiMask",["uiMaskConfig","$parse",function(e,n){return{priority:100,require:"ngModel",restrict:"A",compile:function(){return function(t,i,r,u){function a(){return _=!1,D&&(i.unbind("blur",c),i.unbind("mousedown",f),i.unbind("mouseup",f),i.unbind("input",g),i.unbind("keyup",g),i.unbind("click",g),i.unbind("focus",g),D=!1),angular.isDefined(E)?i.attr("placeholder",E):i.removeAttr("placeholder"),angular.isDefined(R)?i.attr("maxlength",R):i.removeAttr("maxlength"),i.val(u.$modelValue),u.$viewValue=u.$modelValue,!1}function l(e){var n="",t=b.slice();return e=e.toString(),angular.forEach(y,function(n){e=e.replace(n,"")}),angular.forEach(e.split(""),function(e){t.length&&t[0].test(e)&&(n+=e,t.shift())}),n}function o(e){var n="",t=v.slice();return angular.forEach($.split(""),function(i,r){e.length&&r===t[0]?(n+=e.charAt(0)||"_",e=e.substr(1),t.shift()):n+=i}),n}function s(e){var n=0;if(v=[],b=[],$="","string"==typeof e){k=0;var t=!1;e=e.split(""),angular.forEach(e,function(e,i){if(j.maskDefinitions[e]){v.push(n);var u,a=$;u=r.placeholder,u="undefined"!=typeof u&&u[i]?u[i]:"_",$=a+u,b.push(j.maskDefinitions[e]),n++,t||k++}else"?"===e?t=!0:($+=e,n++)})}v.push(v.slice().pop()+1),y=$.replace(/[_]+/g,"_").replace(/([^_]+)([a-zA-Z0-9])([^_])/g,"$1$2_$3").split("_"),_=1<v.length?!0:!1}function c(){S=A=0,V&&0!==x.length||(w="",i.val(""),t.$apply(function(){u.$setViewValue("")}))}function f(e){"mousedown"===e.type?i.bind("mouseout",h):i.unbind("mouseout",h)}function h(){S=m(this),i.unbind("mouseout",h)}function g(e){e=e||{};var n=e.which,r=e.type;if(16!==n&&91!==n){var a=i.val(),s=O,c=l(a),f=M,h=!1,g=d(this)||0,b=A||0,$=g-b,y=v[0],k=v[c.length]||v.slice().shift(),x=S||0,w=0<m(this),V=x>0,_=a.length>s.length||x&&a.length>s.length-x,a=a.length<s.length||x&&a.length===s.length-x;if(e=n>=37&&40>=n&&e.shiftKey,s=8===n||"keyup"!==r&&a&&-1===$,$=46===n||"keyup"!==r&&a&&0===$&&!V,n=(37===n||s||"click"===r)&&g>y,S=m(this),!e&&(!w||"click"!==r&&"keyup"!==r)){if("input"===r&&a&&!V&&c===f){for(;s&&g>y&&!(-1<v.indexOf(g));)g--;for(;$&&k>g&&-1===v.indexOf(g);)g++;h=v.indexOf(g),c=c.substring(0,h)+c.substring(h+1),h=!0}for(O=r=o(c),M=c,i.val(r),h&&t.$apply(function(){u.$setViewValue(c)}),_&&y>=g&&(g=y+1),n&&g--,g=g>k?k:y>g?y:g;!(-1<v.indexOf(g))&&g>y&&k>g;)g+=n?-1:1;(n&&k>g||_&&!(-1<v.indexOf(b)))&&g++,A=g,p(this,g)}}}function d(e){if(!e)return 0;if(void 0!==e.selectionStart)return e.selectionStart;if(document.selection){e.focus();var n=document.selection.createRange();return n.moveStart("character",e.value?-e.value.length:0),n.text.length}return 0}function p(e,n){if(!e)return 0;if(0!==e.offsetWidth&&0!==e.offsetHeight)if(e.setSelectionRange)e.focus(),e.setSelectionRange(n,n);else if(e.createTextRange){var t=e.createTextRange();t.collapse(!0),t.moveEnd("character",n),t.moveStart("character",n),t.select()}}function m(e){return e?void 0!==e.selectionStart?e.selectionEnd-e.selectionStart:document.selection?document.selection.createRange().text.length:0:0}var v,b,$,y,k,x,w,V,O,M,A,S,_=!1,D=!1,E=r.placeholder,R=r.maxlength,j={};r.uiOptions?(j=t.$eval("["+r.uiOptions+"]"),angular.isObject(j[0])&&(j=function(e,n){for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]?angular.extend(n[t],e[t]):n[t]=angular.copy(e[t]));return n}(e,j[0]))):j=e,r.$observe("uiMask",function(e){return angular.isDefined(e)?(s(e),_?(x=M=l(u.$modelValue||""),w=O=o(x),e=(V=x.length?x.length>=k:!0)&&x.length?w:"",r.maxlength&&i.attr("maxlength",2*v[v.length-1]),i.attr("placeholder",$),i.val(e),u.$viewValue=e,D||(i.bind("blur",c),i.bind("mousedown mouseup",f),i.bind("input keyup click focus",g),D=!0),!0):a()):a()}),r.$observe("placeholder",function(e){angular.isDefined(e)&&($=e,_&&g())});var q=!1;r.$observe("modelViewValue",function(e){"true"===e&&(q=!0)}),t.$watch(r.ngModel,function(e){q&&e&&n(r.ngModel).assign(t,u.$viewValue)}),u.$formatters.push(function(e){return _?(x=l(e||""),V=x.length?x.length>=k:!0,u.$setValidity("mask",V),V&&x.length?o(x):void 0):e}),u.$parsers.push(function(e){return _?(x=l(e||""),V=x.length?x.length>=k:!0,u.$viewValue=x.length?o(x):"",u.$setValidity("mask",V),""===x&&r.required&&u.$setValidity("required",!1),V?x:void 0):e}),i.bind("mousedown mouseup",f),Array.prototype.indexOf||(Array.prototype.indexOf=function(e){if(null===this)throw new TypeError;var n=Object(this),t=n.length>>>0;if(0===t)return-1;var i=0;if(1<arguments.length&&(i=Number(arguments[1]),i!==i?i=0:0!==i&&1/0!==i&&-(1/0)!==i&&(i=(i>0||-1)*Math.floor(Math.abs(i)))),i>=t)return-1;for(i=i>=0?i:Math.max(t-Math.abs(i),0);t>i;i++)if(i in n&&n[i]===e)return i;return-1})}}}}]);